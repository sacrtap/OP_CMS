# Story 5.3: 操作审计日志

**Status:** ready-for-dev  
**Epic:** Epic 5 - 用户权限管理  
**Story Points:** 3  
**Priority:** High  

---

## User Story

As a 系统管理员,  
I want 可以查看用户操作审计日志,  
So that 追踪敏感操作的执行情况。

---

## Acceptance Criteria

### AC 1: 进入审计日志页面
- **Given** 系统管理员登录系统并进入审计日志  
- **When** 页面加载完成  
- **Then** 显示所有操作审计日志列表  
- **And** 显示操作人、操作时间、操作内容

### AC 2: 查询审计日志
- **Given** 系统管理员需要查询特定操作  
- **When** 选择时间范围和操作类型进行查询  
- **Then** 系统显示符合条件的操作记录  
- **And** 支持按用户、操作类型、结果状态筛选

### AC 3: 查看操作详情
- **Given** 系统管理员查看审计日志  
- **When** 点击操作记录  
- **Then** 显示详细操作信息（操作前后数据对比）  
- **And** 显示 IP 地址和用户代理

### AC 4: 导出审计日志
- **Given** 系统管理员需要导出审计日志  
- **When** 点击"导出"按钮  
- **Then** 系统导出审计日志为 Excel/CSV  
- **And** 包含所有查询条件下的记录

---

## Tasks / Subtasks

- [ ] Task 1: 实现审计日志 API (AC: 1, 2)
  - [ ] Subtask 1.1: GET /api/v1/audit-logs - 获取审计日志列表
  - [ ] Subtask 1.2: GET /api/v1/audit-logs/:id - 获取审计日志详情
  - [ ] Subtask 1.3: 实现审计日志自动记录中间件

- [ ] Task 2: 实现前端审计日志界面 (AC: 1, 3, 4)
  - [ ] Subtask 2.1: AuditLogs.vue - 审计日志列表组件
  - [ ] Subtask 2.2: AuditLogDetail.vue - 审计日志详情组件
  - [ ] Subtask 2.3: 路由配置 (/admin/audit-logs)

- [ ] Task 3: 编写单元测试 (AC: 1, 2)
  - [ ] Subtask 3.1: 测试审计日志 API
  - [ ] Subtask 3.2: 测试审计日志自动记录
  - [ ] Subtask 3.3: 测试前端组件

---

## Technical Implementation Notes

### Backend Implementation

**Audit Log Model:**
```python
class AuditLog(Base):
    id, user_id, username, action
    resource_type, resource_id
    action_type: create, update, delete, view, export
    old_value: JSON, new_value: JSON
    ip_address, user_agent
    created_at
```

**Audit Log API:**
```python
GET /api/v1/audit-logs
  - Query: user_id, action_type, date_from, date_to
GET /api/v1/audit-logs/:id
```

**Automatic Logging:**
```python
def audit_log(action: str, resource_type: str):
    # Decorator to automatically log actions
    # Capture old/new values for updates
    pass
```

### Frontend Components

**New Components:**
- `AuditLogs.vue` - Audit log list with filters
- `AuditLogDetail.vue` - Detail view with before/after comparison
- Date range picker, user selector, action type filter

---

## Dependencies

- ✅ Story 5.1: 用户账户管理 (已完成 - User 模型)
- ✅ Story 3.2: JWT 认证 (已完成 - 认证基础)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Audit log API working
- [ ] Automatic audit logging middleware
- [ ] Frontend has complete audit log UI
- [ ] Export functionality
- [ ] Unit tests pass (>90% coverage)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
