# Story 4.2: 客户分层和风险预警

**Status:** ready-for-dev  
**Epic:** Epic 4 - 数据分析与报表  
**Story Points:** 5  
**Priority:** High  

---

## User Story

As a 管理人员,  
I want 可以查看客户分层和风险预警信息,  
So that 识别高价值客户和风险客户。

---

## Acceptance Criteria

### AC 1: 进入客户分层页面
- **Given** 管理人员进入数据分析页面  
- **When** 点击"客户分层"模块  
- **Then** 系统显示客户分层结果（高价值/中等/低价值）  
- **And** 显示各层级客户数量和占比

### AC 2: 客户分层展示
- **Given** 管理人员查看客户分层  
- **When** 页面加载完成  
- **Then** 按价值分层显示客户（RFM 模型或自定义规则）  
- **And** 支持切换不同的分层视图

### AC 3: 风险客户预警
- **Given** 存在风险客户（逾期、流失等）  
- **When** 进入风险预警模块  
- **Then** 系统显示风险客户列表并红色标记  
- **And** 显示风险类型和风险等级

### AC 4: 风险详情查看
- **Given** 管理人员查看风险客户  
- **When** 点击风险客户  
- **Then** 显示详细风险信息（逾期金额、逾期天数、历史交易）  
- **And** 支持导出风险客户列表

---

## Tasks / Subtasks

- [ ] Task 1: 实现客户分层 API (AC: 1, 2)
  - [ ] Subtask 1.1: GET /api/v1/customers/segmentation - 获取客户分层数据
  - [ ] Subtask 1.2: 实现 RFM 模型计算逻辑
  - [ ] Subtask 1.3: 实现客户价值分层算法

- [ ] Task 2: 实现风险预警 API (AC: 3, 4)
  - [ ] Subtask 2.1: GET /api/v1/customers/risks - 获取风险客户列表
  - [ ] Subtask 2.2: 实现风险等级计算逻辑
  - [ ] Subtask 2.3: 实现风险类型识别

- [ ] Task 3: 实现前端分层界面 (AC: 1, 2, 3, 4)
  - [ ] Subtask 3.1: CustomerSegmentation.vue - 客户分层组件
  - [ ] Subtask 3.2: RiskWarning.vue - 风险预警组件
  - [ ] Subtask 3.3: 路由配置 (/analytics/segmentation)

- [ ] Task 4: 编写单元测试 (AC: 1, 3)
  - [ ] Subtask 4.1: 测试客户分层算法
  - [ ] Subtask 4.2: 测试风险预警 API
  - [ ] Subtask 4.3: 测试前端组件

---

## Technical Implementation Notes

### Customer Segmentation (RFM Model)

**RFM Scores:**
- **Recency (R):** Days since last purchase
- **Frequency (F):** Number of purchases in period
- **Monetary (M):** Total spending in period

**Segments:**
- VIP: R high, F high, M high
- Loyal: R high, F high, M medium
- At Risk: R low, F high, M high
- Lost: R very low, F low, M low

### Risk Detection

**Risk Types:**
- Overdue risk (payment overdue > 30 days)
- Churn risk (no activity > 90 days)
- Decline risk (revenue decline > 50%)

**Risk Levels:**
- High: Multiple risk factors
- Medium: One significant risk factor
- Low: Minor risk indicators

---

## Dependencies

- ✅ Story 3.1: 自动化账单生成 (已完成 - 提供账单数据)
- ✅ Story 3.4: 收款核销功能 (已完成 - 提供付款数据)
- ✅ Story 4.1: 管理驾驶舱 (已完成 - 提供数据基础)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Customer segmentation API working
- [ ] Risk detection algorithm implemented
- [ ] Frontend has complete segmentation UI
- [ ] Risk warning display working
- [ ] Unit tests pass (>90% coverage)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
