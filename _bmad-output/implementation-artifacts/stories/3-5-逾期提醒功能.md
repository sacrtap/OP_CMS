# Story 3.5: 逾期提醒功能

**Status:** ready-for-dev  
**Epic:** Epic 3 - 结算管理  
**Story Points:** 3  
**Priority:** High  

---

## User Story

As a 运营人员,  
I want 可以发送逾期提醒给客户（邮件、短信）,  
So that 提醒客户及时付款，减少逾期账单。

---

## Acceptance Criteria

### AC 1: 进入逾期提醒页面
- **Given** 运营人员进入逾期提醒页面  
- **When** 页面加载完成  
- **Then** 显示逾期未付款账单列表  
- **And** 显示逾期天数和逾期金额

### AC 2: 选择逾期账单
- **Given** 运营人员查看逾期账单列表  
- **When** 选择一个或多个逾期账单  
- **Then** 显示选中的账单数量  
- **And** 显示应发送提醒的客户列表

### AC 3: 发送逾期提醒
- **Given** 运营人员选择逾期账单  
- **When** 点击"发送提醒"按钮  
- **Then** 系统发送逾期提醒（邮件/短信）  
- **And** 记录发送状态和发送时间

### AC 4: 提醒记录管理
- **Given** 逾期提醒已发送  
- **When** 查看提醒历史记录  
- **Then** 显示发送历史（发送时间、发送方式、客户接收状态）  
- **And** 支持发送二次提醒

---

## Tasks / Subtasks

- [ ] Task 1: 实现逾期提醒数据模型 (AC: 4)
  - [ ] Subtask 1.1: 创建 ReminderRecord 模型（提醒记录）
  - [ ] Subtask 1.2: 创建数据库迁移脚本
  - [ ] Subtask 1.3: 添加逾期计算字段到 SettlementRecord

- [ ] Task 2: 实现逾期提醒 API (AC: 3)
  - [ ] Subtask 2.1: GET /api/v1/settlements/overdue - 查询逾期账单
  - [ ] Subtask 2.2: POST /api/v1/reminders/send - 发送提醒
  - [ ] Subtask 2.3: GET /api/v1/reminders - 查询提醒记录

- [ ] Task 3: 实现前端提醒界面 (AC: 1, 2, 4)
  - [ ] Subtask 3.1: OverdueReminders.vue - 逾期提醒主界面
  - [ ] Subtask 3.2: ReminderForm.vue - 提醒发送表单
  - [ ] Subtask 3.3: ReminderHistory.vue - 提醒历史记录

- [ ] Task 4: 编写单元测试 (AC: 3, 4)
  - [ ] Subtask 4.1: 测试逾期计算逻辑
  - [ ] Subtask 4.2: 测试提醒发送 API
  - [ ] Subtask 4.3: 测试前端组件

---

## Technical Implementation Notes

### Database Schema

**reminder_records:**
```sql
CREATE TABLE reminder_records (
  id INT PRIMARY KEY AUTO_INCREMENT,
  reminder_no VARCHAR(36) UNIQUE NOT NULL,
  settlement_id INT NOT NULL,
  reminder_type VARCHAR(20) NOT NULL,  -- email, sms, phone
  reminder_method VARCHAR(50),  -- email_template, sms_template
  recipient VARCHAR(255) NOT NULL,
  reminder_content TEXT,
  send_status VARCHAR(20) NOT NULL,  -- sent, delivered, failed
  sent_at DATETIME,
  reminder_count INT DEFAULT 1,  -- 1st reminder, 2nd reminder...
  created_by INT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (settlement_id) REFERENCES settlement_records(id)
);
```

### Backend Implementation

**Overdue Calculation:**
```python
def calculate_overdue_days(settlement):
    # Calculate days since due_date
    # Return overdue_days
    pass

def get_overdue_settlements(days_threshold=30):
    # Get all settlements with status != 'paid'
    # Filter by overdue days > threshold
    # Return list of overdue settlements
    pass
```

**Reminder Service:**
```python
class ReminderService:
    def send_reminder(self, settlement, method='email'):
        # Get customer contact info
        # Generate reminder content
        # Send via email/SMS
        # Create reminder record
        pass
```

---

## Dependencies

- ✅ Story 3.1: 自动化账单生成 (已完成 - 提供账单数据)
- ✅ Story 3.2: 账单审核工作流 (已完成 - 提供审核流程)
- ✅ Story 3.4: 收款核销功能 (已完成 - 提供付款状态)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Reminder model created
- [ ] Overdue calculation working
- [ ] Reminder API endpoints working
- [ ] Frontend has complete reminder UI
- [ ] Email/SMS integration
- [ ] Unit tests pass (>90% coverage)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
