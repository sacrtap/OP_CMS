# Story 1.5: 客户信息查看权限

**Status:** ready-for-dev  
**Epic:** Epic 1 - 客户管理  
**Story Points:** 5  
**Priority:** High  

---

## User Story

As a 运营主管,  
I want 可以控制客户信息的查看权限,  
So that 保护敏感客户数据，只有授权人员可以查看。

---

## Acceptance Criteria

### AC 1: 角色权限定义
- **Given** 系统中有不同角色的用户  
- **When** 用户访问客户信息  
- **Then** 系统根据角色控制访问权限  
- **And** 权限级别：运营主管 > 运营人员 > 普通用户

### AC 2: 客户级别权限
- **Given** 运营主管分配客户查看权限  
- **When** 运营人员尝试查看客户信息  
- **Then** 系统检查用户是否有该客户的查看权限  
- **And** 无权限用户无法查看敏感字段（联系方式、邮箱等）

### AC 3: 数据脱敏
- **Given** 普通用户查看客户列表  
- **When** 数据显示在列表中  
- **Then** 敏感字段自动脱敏（手机号中间 4 位、邮箱部分隐藏）  
- **And** 脱敏规则可配置

### AC 4: 权限审计
- **Given** 用户访问客户信息  
- **When** 访问敏感数据  
- **Then** 系统记录访问日志（用户、时间、访问内容）  
- **And** 运营主管可以查看访问日志

---

## Tasks / Subtasks

- [ ] Task 1: 实现权限模型和数据库表 (AC: 1, 4)
  - [ ] Subtask 1.1: 创建用户角色表
  - [ ] Subtask 1.2: 创建客户权限分配表
  - [ ] Subtask 1.3: 创建访问日志表

- [ ] Task 2: 实现后端权限验证 (AC: 1, 2)
  - [ ] Subtask 2.1: 实现角色权限检查中间件
  - [ ] Subtask 2.2: 实现客户级别权限验证
  - [ ] Subtask 2.3: 实现敏感字段过滤

- [ ] Task 3: 实现数据脱敏功能 (AC: 3)
  - [ ] Subtask 3.1: 手机号脱敏（138****8000）
  - [ ] Subtask 3.2: 邮箱脱敏（tes****@example.com）
  - [ ] Subtask 3.3: 信用代码脱敏（9131****MA1K3YJ12X）

- [ ] Task 4: 实现前端权限控制 (AC: 2, 3)
  - [ ] Subtask 4.1: 根据权限显示/隐藏操作按钮
  - [ ] Subtask 4.2: 敏感字段脱敏显示
  - [ ] Subtask 4.3: 无权限提示

- [ ] Task 5: 实现权限管理界面 (AC: 4)
  - [ ] Subtask 5.1: 权限分配界面（运营主管专用）
  - [ ] Subtask 5.2: 访问日志查看界面
  - [ ] Subtask 5.3: 脱敏规则配置

- [ ] Task 6: 编写权限功能测试 (AC: 1, 2, 3, 4)
  - [ ] Subtask 6.1: 权限验证测试
  - [ ] Subtask 6.2: 脱敏功能测试
  - [ ] Subtask 6.3: 访问日志测试

---

## Technical Implementation Notes

### Database Schema

**User Roles:**
```sql
CREATE TABLE user_roles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_name VARCHAR(50) NOT NULL UNIQUE,  -- admin, supervisor, operator, viewer
    permissions JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Customer Access Control:**
```sql
CREATE TABLE customer_access (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT NOT NULL,
    user_id INT NOT NULL,
    access_level VARCHAR(20) NOT NULL,  -- full, masked, none
    granted_by INT,
    granted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_customer_user (customer_id, user_id),
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**Access Log:**
```sql
CREATE TABLE access_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    customer_id INT NOT NULL,
    action VARCHAR(50) NOT NULL,  -- view, edit, delete, export
    accessed_fields JSON,
    ip_address VARCHAR(45),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_access_user (user_id),
    INDEX idx_access_customer (customer_id),
    INDEX idx_access_time (created_at)
);
```

### Backend Implementation

**Permission Decorator:**
```python
@require_permission('view_customer')
async def get_customer(request, customer_id):
    # Check user role and customer access
    pass
```

**Data Masking:**
```python
def mask_phone(phone: str) -> str:
    return re.sub(r'(\d{3})\d{4}(\d{4})', r'\1****\2', phone)

def mask_email(email: str) -> str:
    name, domain = email.split('@')
    masked_name = name[0] + '****' + name[-1] if len(name) > 2 else '****'
    return f'{masked_name}@{domain}'
```

### Frontend Components

**New Components:**
- `CustomerPermissions.vue` - Permission management UI
- `AccessLogTable.vue` - Access log viewer
- `MaskedField.vue` - Reusable masked display component

---

## Dependencies

- ✅ Story 1.1: 客户基础信息维护 (已完成 - Customer 模型)
- ✅ Story 1.3: 客户信息编辑与删除 (已完成 - 基础权限控制)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Role-based access control works
- [ ] Customer-level permissions enforced
- [ ] Data masking for sensitive fields
- [ ] Access logging implemented
- [ ] Unit tests pass (>90% coverage)
- [ ] Security audit passed

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
