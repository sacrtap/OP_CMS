# Story 3.1: 自动化账单生成

**Status:** ready-for-dev  
**Epic:** Epic 3 - 结算管理  
**Story Points:** 8  
**Priority:** High  

---

## User Story

As a 运营人员,  
I want 可以自动生成客户账单（根据预配置的价格模式）,  
So that 替代手工计算，提高结算效率。

---

## Acceptance Criteria

### AC 1: 进入结算管理页面
- **Given** 运营人员进入结算管理页面  
- **When** 页面加载完成  
- **Then** 显示结算周期选择和客户列表  
- **And** 显示待结算客户数量

### AC 2: 自动生成账单
- **Given** 运营人员选择结算周期  
- **When** 点击"生成账单"按钮  
- **Then** 系统自动计算所有客户的账单金额  
- **And** 根据预配置的价格模式（单层/多层/阶梯）计算

### AC 3: 显示生成进度
- **Given** 账单生成任务启动  
- **When** 系统正在计算账单  
- **Then** 显示生成进度（已完成/总数）  
- **And** 支持取消操作

### AC 4: 生成详细账单记录
- **Given** 账单生成完成  
- **When** 查看生成的账单  
- **Then** 显示详细的账单记录（用量、单价、总金额）  
- **And** 支持导出账单（PDF/Excel）

---

## Tasks / Subtasks

- [ ] Task 1: 实现账单生成核心逻辑 (AC: 2)
  - [ ] Subtask 1.1: 创建 SettlementService 服务类
  - [ ] Subtask 1.2: 实现单层定价账单计算
  - [ ] Subtask 1.3: 实现多层定价账单计算
  - [ ] Subtask 1.4: 实现阶梯累进定价账单计算

- [ ] Task 2: 实现账单生成 API (AC: 1, 2, 3)
  - [ ] Subtask 2.1: POST /api/v1/settlements/generate - 生成账单
  - [ ] Subtask 2.2: GET /api/v1/settlements/generation-status/:id - 查询生成进度
  - [ ] Subtask 2.3: GET /api/v1/settlements - 查询账单列表

- [ ] Task 3: 实现前端结算管理界面 (AC: 1, 3, 4)
  - [ ] Subtask 3.1: SettlementList.vue - 账单列表组件
  - [ ] Subtask 3.2: GenerateSettlement.vue - 生成账单组件
  - [ ] Subtask 3.3: 路由配置 (/settlements)

- [ ] Task 4: 编写单元测试 (AC: 2, 4)
  - [ ] Subtask 4.1: 测试账单计算逻辑
  - [ ] Subtask 4.2: 测试 API 端点
  - [ ] Subtask 4.3: 测试前端组件

---

## Technical Implementation Notes

### Database Schema

**settlement_records (已有表扩展):**
```sql
ALTER TABLE settlement_records ADD COLUMN:
- usage_data JSON COMMENT '用量数据明细'
- calculation_breakdown JSON COMMENT '计算过程明细'
- generated_by INT COMMENT '生成用户 ID'
- generation_status VARCHAR(20) COMMENT '生成状态'
```

### Backend Implementation

**SettlementService:**
```python
class SettlementService:
    def generate_settlement(
        self,
        customer_id: int,
        period_start: datetime,
        period_end: datetime
    ) -> SettlementRecord:
        # Get customer's pricing config
        # Calculate usage based on pricing model
        # Apply pricing rules
        # Create settlement record
        pass
```

**Pricing Calculation:**
```python
def calculate_price(config, usage_quantity):
    if config.price_model == 'single':
        return usage_quantity * config.unit_price
    elif config.price_model == 'multi':
        # Find appropriate tier
        # Return tier price * usage
        pass
    elif config.price_model == 'tiered':
        # Progressive calculation
        # Sum of each tier
        pass
```

### Frontend Components

**New Components:**
- `SettlementList.vue` - Settlement records list
- `GenerateSettlement.vue` - Generate settlement form
- `SettlementProgress.vue` - Generation progress display

---

## Dependencies

- ✅ Story 2.1: 单层定价模式配置 (已完成 - 提供价格计算基础)
- ✅ Story 2.2: 多层定价模式配置 (已完成 - 提供多层定价计算)
- ✅ Story 2.3: 阶梯累进定价 (已完成 - 提供累进计算逻辑)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Settlement calculation works for all pricing models
- [ ] Progress tracking implemented
- [ ] Frontend has complete settlement UI
- [ ] Unit tests pass (>90% coverage for calculation logic)
- [ ] Performance: Can generate 1000 settlements in <30s

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
