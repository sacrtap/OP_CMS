# Story 2.1: 单层定价模式配置

**Status:** ready-for-dev  
**Epic:** Epic 2 - 定价配置管理  
**Story Points:** 3  
**Priority:** High  
**Sprint:** Sprint 2  

---

## User Story

As a 运营人员,  
I want 可以配置单层定价模式（固定价格）,  
So that 为客户设置简单的定价规则。

---

## Acceptance Criteria

### AC 1: 进入定价配置页面
- **Given** 运营人员已登录系统  
- **When** 导航到定价配置管理页面  
- **Then** 系统显示定价配置列表和创建按钮  
- **And** 支持按客户搜索和筛选

### AC 2: 创建单层定价配置
- **Given** 运营人员在定价配置页面  
- **When** 点击"新建定价配置"并选择"单层定价"模式  
- **Then** 系统显示单层定价配置表单  
- **And** 表单包含必填字段：客户、设备系列、单价、币种

### AC 3: 保存定价配置
- **Given** 运营人员填写完定价配置表单  
- **When** 点击"保存"按钮  
- **Then** 系统验证数据并保存定价配置  
- **And** 显示保存成功提示并返回列表

### AC 4: 支持多设备系列
- **Given** 运营人员为客户配置定价  
- **When** 选择不同设备系列（X/N/L）  
- **Then** 系统支持为每个设备系列设置独立单价  
- **And** 同一客户可以有多个设备系列的定价配置

---

## Tasks / Subtasks

### Task 1: 扩展 PriceConfig 数据模型 (AC: 2, 4)
- [ ] Subtask 1.1: 添加 device_series 字段（枚举：X, N, L）
- [ ] Subtask 1.2: 添加 price_model 字段（枚举：single, multi, tiered）
- [ ] Subtask 1.3: 更新数据库迁移脚本
- [ ] Subtask 1.4: 创建 SingleTierPricing Pydantic 模型

### Task 2: 实现后端 API 接口 (AC: 1, 2, 3)
- [ ] Subtask 2.1: GET /api/v1/pricing - 列表查询（分页、搜索）
- [ ] Subtask 2.2: POST /api/v1/pricing - 创建定价配置
- [ ] Subtask 2.3: GET /api/v1/pricing/:id - 获取详情
- [ ] Subtask 2.4: PUT /api/v1/pricing/:id - 更新定价配置
- [ ] Subtask 2.5: DELETE /api/v1/pricing/:id - 删除定价配置
- [ ] Subtask 2.6: 数据验证（必填字段、唯一性）

### Task 3: 实现前端定价配置界面 (AC: 1, 2, 3, 4)
- [ ] Subtask 3.1: PricingList.vue - 定价配置列表组件
- [ ] Subtask 3.2: PricingForm.vue - 定价配置表单组件
- [ ] Subtask 3.3: DeviceSeriesSelector.vue - 设备系列选择器
- [ ] Subtask 3.4: 前端表单验证逻辑
- [ ] Subtask 3.5: 路由配置（/pricing）

### Task 4: 编写单元测试 (AC: 2, 3)
- [ ] Subtask 4.1: PriceConfig 模型测试
- [ ] Subtask 4.2: 定价 API 接口测试
- [ ] Subtask 4.3: 前端组件测试
- [ ] Subtask 4.4: 数据验证测试

---

## Technical Implementation Notes

### Database Schema Changes

**PriceConfig Table Extension:**
```sql
ALTER TABLE price_configs ADD COLUMN price_model VARCHAR(20) NOT NULL DEFAULT 'single' 
  COMMENT '定价模式：single(单层), multi(多层), tiered(阶梯)';

ALTER TABLE price_configs ADD COLUMN device_series VARCHAR(10) NOT NULL DEFAULT 'X'
  COMMENT '设备系列：X, N, L';

ALTER TABLE price_configs ADD COLUMN unit_price DECIMAL(12, 4) NOT NULL
  COMMENT '单价（单层定价模式）';

ALTER TABLE price_configs ADD UNIQUE KEY unique_customer_device (customer_id, device_series);

CREATE INDEX idx_price_config_model ON price_configs(price_model);
CREATE INDEX idx_price_config_series ON price_configs(device_series);
```

### Backend Models

**PriceConfig Extension (database_models.py):**
```python
class PriceConfig(Base):
    # Existing fields...
    
    # New fields for Story 2.1
    price_model = Column(String(20), nullable=False, default='single', 
                         comment="Pricing model: single, multi, tiered")
    device_series = Column(String(10), nullable=False, default='X',
                           comment="Device series: X, N, L")
    unit_price = Column(DECIMAL(12, 4), nullable=False,
                        comment="Unit price for single-tier pricing")
    
    # Relationships
    customer = relationship("Customer", back_populates="price_configs")
```

**Pydantic Schemas:**
```python
class SingleTierPricingCreate(BaseModel):
    customer_id: int
    device_series: str = Field(..., pattern="^(X|N|L)$")
    price_model: str = Field(default='single', pattern="^single$")
    unit_price: Decimal = Field(..., gt=0)
    currency: str = Field(default='CNY', pattern="^(CNY|USD|EUR)$")
    min_quantity: Optional[Decimal] = Field(None, ge=0)
    max_quantity: Optional[Decimal] = Field(None, ge=0)
    is_active: bool = Field(default=True)
    
    @field_validator('unit_price')
    def validate_price(cls, v):
        if v <= 0:
            raise ValueError('Unit price must be greater than 0')
        return v

class SingleTierPricingResponse(BaseModel):
    id: int
    customer_id: int
    company_name: str  # from Customer relationship
    device_series: str
    price_model: str
    unit_price: Decimal
    currency: str
    min_quantity: Optional[Decimal]
    max_quantity: Optional[Decimal]
    is_active: bool
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True
```

### API Endpoints

**Pricing API (backend/api/pricing.py):**
```python
@pricing_bp.route('', methods=['GET'])
async def list_pricing(request):
    """
    List pricing configurations with filtering
    
    Query Parameters:
    - page, page_size: Pagination
    - customer_id: Filter by customer
    - device_series: Filter by series (X, N, L)
    - price_model: Filter by model (single, multi, tiered)
    - search: Search by company name
    """
    pass

@pricing_bp.route('', methods=['POST'])
async def create_pricing(request):
    """
    Create new pricing configuration
    
    Request Body:
    {
        "customer_id": 1,
        "device_series": "X",
        "price_model": "single",
        "unit_price": 0.10,
        "currency": "CNY",
        "min_quantity": 0,
        "max_quantity": 100,
        "is_active": true
    }
    """
    pass

@pricing_bp.route('/<pricing_id:int>', methods=['GET'])
async def get_pricing(request, pricing_id):
    """Get pricing configuration details"""
    pass

@pricing_bp.route('/<pricing_id:int>', methods=['PUT'])
async def update_pricing(request, pricing_id):
    """Update pricing configuration"""
    pass

@pricing_bp.route('/<pricing_id:int>', methods=['DELETE'])
async def delete_pricing(request, pricing_id):
    """Delete pricing configuration"""
    pass
```

### Frontend Components

**PricingList.vue:**
```vue
<template>
  <div class="pricing-list">
    <div class="header-actions">
      <h2>定价配置管理</h2>
      <el-button type="primary" @click="handleCreate">
        <el-icon><Plus /></el-icon>
        新建定价配置
      </el-button>
    </div>
    
    <!-- Search and Filters -->
    <el-form :inline="true" :model="filters">
      <el-form-item label="客户">
        <el-input v-model="filters.search" placeholder="搜索公司名称" />
      </el-form-item>
      <el-form-item label="设备系列">
        <el-select v-model="filters.device_series" clearable>
          <el-option label="X 系列" value="X" />
          <el-option label="N 系列" value="N" />
          <el-option label="L 系列" value="L" />
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="handleSearch">搜索</el-button>
      </el-form-item>
    </el-form>
    
    <!-- Pricing Table -->
    <el-table :data="pricingList" v-loading="loading">
      <el-table-column prop="company_name" label="客户名称" />
      <el-table-column prop="device_series" label="设备系列" width="100">
        <template #default="{ row }">
          <el-tag>{{ row.device_series }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="price_model" label="定价模式" width="100" />
      <el-table-column prop="unit_price" label="单价" width="100">
        <template #default="{ row }">
          ¥{{ row.unit_price }}
        </template>
      </el-table-column>
      <el-table-column prop="currency" label="币种" width="80" />
      <el-table-column label="状态" width="80">
        <template #default="{ row }">
          <el-tag :type="row.is_active ? 'success' : 'info'">
            {{ row.is_active ? '启用' : '禁用' }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="200">
        <template #default="{ row }">
          <el-button link type="primary" @click="handleEdit(row)">编辑</el-button>
          <el-button link type="danger" @click="handleDelete(row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    
    <!-- Pagination -->
    <el-pagination ... />
  </div>
</template>
```

**PricingForm.vue:**
```vue
<template>
  <el-dialog :model-value="visible" :title="isEdit ? '编辑定价配置' : '新建定价配置'">
    <el-form ref="formRef" :model="formData" :rules="formRules" label-width="120px">
      <el-form-item label="客户" prop="customer_id">
        <el-select v-model="formData.customer_id" placeholder="选择客户" filterable>
          <el-option 
            v-for="customer in customers" 
            :key="customer.customer_id"
            :label="customer.company_name"
            :value="customer.id"
          />
        </el-select>
      </el-form-item>
      
      <el-form-item label="设备系列" prop="device_series">
        <el-select v-model="formData.device_series" placeholder="选择设备系列">
          <el-option label="X 系列" value="X" />
          <el-option label="N 系列" value="N" />
          <el-option label="L 系列" value="L" />
        </el-select>
      </el-form-item>
      
      <el-form-item label="定价模式">
        <el-radio-group v-model="formData.price_model" disabled>
          <el-radio label="single">单层定价</el-radio>
        </el-radio-group>
      </el-form-item>
      
      <el-form-item label="单价" prop="unit_price">
        <el-input-number 
          v-model="formData.unit_price" 
          :min="0.01" 
          :precision="4"
          :step="0.01"
        />
      </el-form-item>
      
      <el-form-item label="币种" prop="currency">
        <el-select v-model="formData.currency">
          <el-option label="人民币" value="CNY" />
          <el-option label="美元" value="USD" />
          <el-option label="欧元" value="EUR" />
        </el-select>
      </el-form-item>
      
      <el-form-item label="最小数量" prop="min_quantity">
        <el-input-number v-model="formData.min_quantity" :min="0" :precision="2" />
      </el-form-item>
      
      <el-form-item label="最大数量" prop="max_quantity">
        <el-input-number v-model="formData.max_quantity" :min="0" :precision="2" />
      </el-form-item>
      
      <el-form-item label="启用">
        <el-switch v-model="formData.is_active" />
      </el-form-item>
    </el-form>
    
    <template #footer>
      <el-button @click="handleClose">取消</el-button>
      <el-button type="primary" @click="handleSubmit">保存</el-button>
    </template>
  </el-dialog>
</template>
```

---

## Dependencies

- ✅ Story 1.1: 客户基础信息维护 (已完成 - Customer 模型)
- ✅ Story 1.3: 客户信息编辑与删除 (已完成 - CRUD 模式参考)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Database migration completed
- [ ] Backend API endpoints working
- [ ] Frontend pricing management UI complete
- [ ] Unit tests passing (>90% coverage)
- [ ] Code committed and pushed to remote
- [ ] Story status updated to "done"

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- 2026-02-25: Story created from epics.md for Sprint 2
