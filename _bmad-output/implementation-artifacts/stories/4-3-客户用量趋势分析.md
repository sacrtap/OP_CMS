# Story 4.3: 客户用量趋势分析

**Status:** ready-for-dev  
**Epic:** Epic 4 - 数据分析与报表  
**Story Points:** 3  
**Priority:** High  

---

## User Story

As a 销售负责人,  
I want 可以查看客户用量趋势分析图表,  
So that 了解客户的业务发展情况。

---

## Acceptance Criteria

### AC 1: 进入客户用量趋势页面
- **Given** 销售负责人进入客户管理页面  
- **When** 选择负责的客户并点击"用量趋势"  
- **Then** 系统显示该客户的用量趋势图表  
- **And** 支持按时间维度（月/季/年）查看趋势

### AC 2: 查看用量趋势图表
- **Given** 销售负责人查看用量趋势  
- **When** 页面加载完成  
- **Then** 显示客户历史用量趋势（折线图/柱状图）  
- **And** 显示当前用量和历史对比

### AC 3: 时间维度切换
- **Given** 销售负责人查看趋势图表  
- **When** 切换时间维度（月/季/年）  
- **Then** 系统按选定维度重新计算和显示趋势  
- **And** 支持自定义时间范围

### AC 4: 用量异常预警
- **Given** 客户用量出现异常波动  
- **When** 查看用量趋势  
- **Then** 系统标记异常点并提示  
- **And** 显示异常原因分析

---

## Tasks / Subtasks

- [ ] Task 1: 实现用量趋势 API (AC: 1, 2, 3)
  - [ ] Subtask 1.1: GET /api/v1/customers/:id/usage-trend - 获取客户用量趋势
  - [ ] Subtask 1.2: 支持月/季/年时间维度
  - [ ] Subtask 1.3: 实现异常检测算法

- [ ] Task 2: 实现前端趋势界面 (AC: 1, 2, 3, 4)
  - [ ] Subtask 2.1: UsageTrend.vue - 用量趋势组件
  - [ ] Subtask 2.2: 集成 ECharts 图表
  - [ ] Subtask 2.3: 时间维度切换功能

- [ ] Task 3: 编写单元测试 (AC: 1, 3)
  - [ ] Subtask 3.1: 测试用量趋势 API
  - [ ] Subtask 3.2: 测试异常检测算法
  - [ ] Subtask 3.3: 测试前端组件

---

## Technical Implementation Notes

### Backend API

```python
GET /api/v1/customers/:id/usage-trend
Query: dimension=month&range=6

Response:
{
  "success": true,
  "data": {
    "customer_id": 1,
    "company_name": "Test Company",
    "trend": [
      {"date": "2026-01", "usage": 1000, "amount": 100},
      {"date": "2026-02", "usage": 1200, "amount": 120}
    ],
    "anomalies": [
      {"date": "2026-02", "type": "spike", "percentage": 20}
    ],
    "dimension": "month",
    "range": 6
  }
}
```

### Anomaly Detection

**Methods:**
- Z-score method (> 2 standard deviations)
- Moving average comparison
- Month-over-month change (> 50%)

---

## Dependencies

- ✅ Story 3.1: 自动化账单生成 (已完成 - 提供用量数据)
- ✅ Story 4.1: 管理驾驶舱 (已完成 - 提供数据基础)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Usage trend API working
- [ ] Frontend trend chart component
- [ ] Time dimension switching
- [ ] Anomaly detection implemented
- [ ] Unit tests pass (>90% coverage)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
