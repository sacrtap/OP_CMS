# Story 3.4: 收款核销功能

**Status:** ready-for-dev  
**Epic:** Epic 3 - 结算管理  
**Story Points:** 5  
**Priority:** High  

---

## User Story

As a 运营人员,  
I want 可以记录客户的付款信息（收款核销）,  
So that 跟踪账单的付款状态。

---

## Acceptance Criteria

### AC 1: 进入收款核销页面
- **Given** 运营人员进入收款核销页面  
- **When** 页面加载完成  
- **Then** 显示待核销账单列表  
- **And** 显示待核销账单总金额

### AC 2: 录入付款信息
- **Given** 运营人员选择待核销账单  
- **When** 录入付款信息（付款金额、付款方式、付款时间）  
- **Then** 系统保存付款记录  
- **And** 支持附件上传（银行回单等）

### AC 3: 账单核销
- **Given** 付款信息已录入  
- **When** 点击"核销"按钮  
- **Then** 系统匹配账单与付款并更新账单状态  
- **And** 支持部分核销和合并核销功能

### AC 4: 核销记录管理
- **Given** 账单已核销  
- **When** 查看核销历史记录  
- **Then** 显示核销详情（核销时间、核销金额、操作人员）  
- **And** 支持取消核销（特殊情况）

---

## Tasks / Subtasks

- [ ] Task 1: 实现收款核销数据模型 (AC: 2, 4)
  - [ ] Subtask 1.1: 创建 PaymentRecord 模型（付款记录）
  - [ ] Subtask 1.2: 创建 SettlementWriteoff 模型（核销记录）
  - [ ] Subtask 1.3: 创建数据库迁移脚本

- [ ] Task 2: 实现收款核销 API (AC: 2, 3)
  - [ ] Subtask 2.1: POST /api/v1/payments - 录入付款
  - [ ] Subtask 2.2: POST /api/v1/settlements/:id/writeoff - 核销账单
  - [ ] Subtask 2.3: GET /api/v1/settlements/:id/writeoffs - 查询核销记录

- [ ] Task 3: 实现前端核销界面 (AC: 1, 2, 4)
  - [ ] Subtask 3.1: PaymentWriteoff.vue - 收款核销主界面
  - [ ] Subtask 3.2: PaymentForm.vue - 付款录入表单
  - [ ] Subtask 3.3: WriteoffHistory.vue - 核销历史记录

- [ ] Task 4: 编写单元测试 (AC: 3, 4)
  - [ ] Subtask 4.1: 测试核销逻辑（部分核销、合并核销）
  - [ ] Subtask 4.2: 测试 API 端点
  - [ ] Subtask 4.3: 测试前端组件

---

## Technical Implementation Notes

### Database Schema

**payment_records:**
```sql
CREATE TABLE payment_records (
  id INT PRIMARY KEY AUTO_INCREMENT,
  payment_no VARCHAR(36) UNIQUE NOT NULL,
  customer_id INT NOT NULL,
  payment_amount DECIMAL(12, 2) NOT NULL,
  payment_method VARCHAR(50) NOT NULL,  -- bank_transfer, cash, check, online
  payment_date DATE NOT NULL,
  payment_account VARCHAR(100),  -- Bank account
  attachment_url VARCHAR(500),
  remarks TEXT,
  created_by INT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (customer_id) REFERENCES customers(id)
);
```

**settlement_writeoffs:**
```sql
CREATE TABLE settlement_writeoffs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  writeoff_no VARCHAR(36) UNIQUE NOT NULL,
  payment_id INT NOT NULL,
  settlement_id INT NOT NULL,
  writeoff_amount DECIMAL(12, 2) NOT NULL,
  writeoff_type VARCHAR(20) NOT NULL,  -- full, partial, merged
  writeoff_date DATETIME DEFAULT CURRENT_TIMESTAMP,
  created_by INT,
  FOREIGN KEY (payment_id) REFERENCES payment_records(id),
  FOREIGN KEY (settlement_id) REFERENCES settlement_records(id)
);
```

### Backend Implementation

**Writeoff Logic:**
```python
class SettlementWriteoffService:
    def writeoff_settlement(self, payment, settlements):
        # Check if payment amount matches settlement total
        # Support partial writeoff
        # Support merged writeoff (multiple settlements)
        # Update settlement status to 'paid'
        # Create writeoff records
        pass
```

---

## Dependencies

- ✅ Story 3.1: 自动化账单生成 (已完成 - 提供账单数据)
- ✅ Story 3.2: 账单审核工作流 (已完成 - 提供审核流程)
- ✅ Story 3.3: 账单校验与发送 (已完成 - 提供校验功能)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Payment and writeoff models created
- [ ] Writeoff API endpoints working
- [ ] Frontend has complete writeoff UI
- [ ] Partial and merged writeoff supported
- [ ] Unit tests pass (>90% coverage)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
