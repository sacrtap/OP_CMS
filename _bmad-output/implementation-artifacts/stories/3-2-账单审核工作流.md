# Story 3.2: 账单审核工作流

**Status:** ready-for-dev  
**Epic:** Epic 3 - 结算管理  
**Story Points:** 5  
**Priority:** High  

---

## User Story

As a 运营主管,  
I want 可以审核账单并批准付款,  
So that 确保账单准确性，控制付款流程。

---

## Acceptance Criteria

### AC 1: 进入账单审核页面
- **Given** 运营主管进入账单审核页面  
- **When** 页面加载完成  
- **Then** 显示待审核账单列表  
- **And** 显示待审核账单数量

### AC 2: 查看账单详情
- **Given** 运营主管查看账单详情  
- **When** 点击账单记录  
- **Then** 显示完整账单信息（用量明细、计算过程）  
- **And** 显示客户信息和价格配置

### AC 3: 审核账单
- **Given** 运营主管审核账单  
- **When** 点击"批准"或"拒绝"按钮  
- **Then** 系统更新账单状态  
- **And** 记录审核人和审核时间

### AC 4: 批量审核
- **Given** 存在多个待审核账单  
- **When** 选择多个账单并点击"批量批准"  
- **Then** 系统批量更新账单状态  
- **And** 显示批量审核结果

---

## Tasks / Subtasks

- [ ] Task 1: 实现账单审核 API (AC: 3, 4)
  - [ ] Subtask 1.1: PUT /api/v1/settlements/:id/approve - 批准账单
  - [ ] Subtask 1.2: PUT /api/v1/settlements/:id/reject - 拒绝账单
  - [ ] Subtask 1.3: POST /api/v1/settlements/bulk-approve - 批量批准

- [ ] Task 2: 实现前端审核界面 (AC: 1, 2, 4)
  - [ ] Subtask 2.1: SettlementReview.vue - 审核列表组件
  - [ ] Subtask 2.2: SettlementApproval.vue - 批量审核组件
  - [ ] Subtask 2.3: 路由配置 (/settlements/review)

- [ ] Task 3: 编写单元测试 (AC: 3, 4)
  - [ ] Subtask 3.1: 测试审核 API 端点
  - [ ] Subtask 3.2: 测试账单状态变更
  - [ ] Subtask 3.3: 测试批量审核逻辑

---

## Technical Implementation Notes

### Backend Implementation

**API Endpoints:**
```python
# Approve single settlement
PUT /api/v1/settlements/:id/approve
{
  "approved_by": 1,
  "approval_remarks": "Approved"
}

# Reject single settlement
PUT /api/v1/settlements/:id/reject
{
  "rejected_by": 1,
  "rejection_reason": "Incorrect usage data"
}

# Bulk approve
POST /api/v1/settlements/bulk-approve
{
  "settlement_ids": [1, 2, 3],
  "approved_by": 1
}
```

**Database Updates:**
```sql
UPDATE settlement_records SET
  status = 'approved',
  approved_at = NOW(),
  approved_by = :user_id
WHERE id = :settlement_id
```

### Frontend Components

**New Components:**
- `SettlementReview.vue` - Review list with filters
- `SettlementApproval.vue` - Bulk approval dialog
- `SettlementDetail.vue` - Detail view with calculation breakdown

---

## Dependencies

- ✅ Story 3.1: 自动化账单生成 (已完成 - 提供账单数据)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Approval API endpoints working
- [ ] Frontend has complete review UI
- [ ] Bulk approval implemented
- [ ] Unit tests pass (>90% coverage)
- [ ] Audit trail for all approvals

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
