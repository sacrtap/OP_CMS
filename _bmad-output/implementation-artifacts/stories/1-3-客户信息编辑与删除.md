# Story 1.3: 客户信息编辑与删除

**Status:** ready-for-dev  
**Epic:** Epic 1 - 客户管理  
**Story Points:** 3  
**Priority:** High  

---

## User Story

As a 运营人员,  
I want 可以编辑和删除客户信息,  
So that 保持客户数据的准确性和时效性。

---

## Acceptance Criteria

### AC 1: 编辑客户信息
- **Given** 运营人员查看客户列表或详情  
- **When** 点击编辑按钮并修改客户信息  
- **Then** 系统保存修改并显示更新后的数据  
- **And** 记录修改日志（修改时间、修改内容）

### AC 2: 编辑验证
- **Given** 运营人员编辑客户信息  
- **When** 修改公司名称、信用代码等关键字段  
- **Then** 系统验证数据唯一性（不能与其他客户重复）  
- **And** 显示验证错误提示

### AC 3: 删除客户
- **Given** 运营人员需要删除客户  
- **When** 点击删除按钮并确认  
- **Then** 系统删除客户及其关联数据（价格配置、结算记录）  
- **And** 显示删除成功提示

### AC 4: 删除保护
- **Given** 客户有关联的结算记录  
- **When** 运营人员尝试删除该客户  
- **Then** 系统提示客户存在关联数据  
- **And** 要求二次确认或阻止删除

---

## Tasks / Subtasks

- [ ] Task 1: 完善后端编辑和删除 API (AC: 1, 2, 3)
  - [ ] Subtask 1.1: 增强更新 API 支持部分字段更新
  - [ ] Subtask 1.2: 实现数据唯一性验证
  - [ ] Subtask 1.3: 添加修改日志记录功能

- [ ] Task 2: 完善前端编辑功能 (AC: 1, 2)
  - [ ] Subtask 2.1: 优化表单组件支持编辑模式
  - [ ] Subtask 2.2: 实现编辑确认和验证提示
  - [ ] Subtask 2.3: 添加修改历史记录展示

- [ ] Task 3: 完善前端删除功能 (AC: 3, 4)
  - [ ] Subtask 3.1: 实现删除确认对话框
  - [ ] Subtask 3.2: 检查关联数据并提示
  - [ ] Subtask 3.3: 批量删除功能（可选）

- [ ] Task 4: 编写编辑删除测试 (AC: 1, 2, 3, 4)
  - [ ] Subtask 4.1: 编写更新 API 测试
  - [ ] Subtask 4.2: 编写删除 API 测试
  - [ ] Subtask 4.3: 编写前端组件交互测试

---

## Technical Implementation Notes

### Backend Enhancements

**Enhanced Update API:**
```python
PUT /api/v1/customers/:id
{
  "company_name": "Updated Name",
  "contact_phone": "13900139000"
  // Partial update supported
}

Response:
{
  "success": true,
  "data": { ...updated customer... },
  "message": "Customer updated successfully"
}
```

**Delete with Cascade:**
```python
DELETE /api/v1/customers/:id

# Cascade delete:
# - Price configurations
# - Settlement records
# - Related data
```

**Change Log:**
```python
# New table: customer_change_log
- id
- customer_id
- changed_by
- changed_at
- changes: JSON  # {field, old_value, new_value}
```

### Frontend Components

**Enhanced Features:**
- Edit button in CustomerList and CustomerDetail
- Confirmation dialog for delete
- Warning for related data
- Success/error notifications
- Form validation feedback

---

## Dependencies

- ✅ Story 1.1: 客户基础信息维护 (已完成 - 提供基础 CRUD)
- ✅ Story 1.2: 客户信息查询与搜索 (已完成 - 提供搜索功能)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Update API supports partial updates with validation
- [ ] Delete API checks for related data
- [ ] Frontend has edit and delete functionality
- [ ] Confirmation dialogs implemented
- [ ] Unit tests pass (>90% coverage)
- [ ] Change log feature implemented

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
