# Story 3.3: 账单校验与发送

**Status:** ready-for-dev  
**Epic:** Epic 3 - 结算管理  
**Story Points:** 5  
**Priority:** High  

---

## User Story

As a 运营人员,  
I want 可以结算和校验账单的准确性并发送给客户,  
So that 确保账单的正确性并及时发送。

---

## Acceptance Criteria

### AC 1: 进入账单校验页面
- **Given** 运营人员进入结算管理页面  
- **When** 选择需要校验的账单  
- **Then** 显示账单详细信息（用量、单价、总金额）  
- **And** 显示校验结果（正常/异常）

### AC 2: 校验账单准确性
- **Given** 运营人员点击"校验"按钮  
- **When** 系统执行账单校验  
- **Then** 系统检查账单数据的合理性  
- **And** 标记异常数据并显示详细错误信息

### AC 3: 发送账单给客户
- **Given** 账单校验通过  
- **When** 运营人员点击"发送"按钮  
- **Then** 系统发送账单给客户（邮件/短信）  
- **And** 记录发送状态和发送时间

### AC 4: 发送记录管理
- **Given** 账单已发送  
- **When** 查看账单发送记录  
- **Then** 显示发送历史（发送时间、发送方式、接收状态）  
- **And** 支持重新发送

---

## Tasks / Subtasks

- [ ] Task 1: 实现账单校验逻辑 (AC: 2)
  - [ ] Subtask 1.1: 创建 SettlementValidationService 服务类
  - [ ] Subtask 1.2: 实现数据合理性检查（用量突增、单价异常）
  - [ ] Subtask 1.3: 实现异常标记功能

- [ ] Task 2: 实现账单发送 API (AC: 3)
  - [ ] Subtask 2.1: POST /api/v1/settlements/:id/send - 发送账单
  - [ ] Subtask 2.2: 邮件发送集成
  - [ ] Subtask 2.3: 短信发送集成

- [ ] Task 3: 实现前端校验发送界面 (AC: 1, 4)
  - [ ] Subtask 3.1: SettlementValidation.vue - 校验界面
  - [ ] Subtask 3.2: SendHistory.vue - 发送历史记录
  - [ ] Subtask 3.3: 路由配置

- [ ] Task 4: 编写单元测试 (AC: 2, 3)
  - [ ] Subtask 4.1: 测试账单校验逻辑
  - [ ] Subtask 4.2: 测试发送 API 端点
  - [ ] Subtask 4.3: 测试邮件/短信发送

---

## Technical Implementation Notes

### Backend Implementation

**Validation Rules:**
```python
class SettlementValidationService:
    def validate_settlement(self, settlement):
        # Check usage quantity spike (>50% increase)
        # Check unit price consistency
        # Check total amount calculation
        # Return validation result with errors
        pass
```

**Send API:**
```python
POST /api/v1/settlements/:id/send
{
  "method": "email",  // email or sms
  "recipient": "customer@example.com",
  "sent_by": 1
}
```

### Database Schema

**settlement_send_logs:**
```sql
CREATE TABLE settlement_send_logs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  settlement_id INT NOT NULL,
  send_method VARCHAR(20),  -- email, sms
  recipient VARCHAR(255),
  sent_at DATETIME,
  status VARCHAR(20),  -- sent, delivered, failed
  error_message TEXT,
  FOREIGN KEY (settlement_id) REFERENCES settlement_records(id)
);
```

---

## Dependencies

- ✅ Story 3.1: 自动化账单生成 (已完成 - 提供账单数据)
- ✅ Story 3.2: 账单审核工作流 (已完成 - 提供审核流程)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Validation service working with error detection
- [ ] Email/SMS sending integrated
- [ ] Frontend has validation and send UI
- [ ] Send history tracking implemented
- [ ] Unit tests pass (>90% coverage)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
