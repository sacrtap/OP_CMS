# Story 5.2: 角色分配与权限控制

**Status:** ready-for-dev  
**Epic:** Epic 5 - 用户权限管理  
**Story Points:** 5  
**Priority:** High  

---

## User Story

As a 系统管理员,  
I want 可以为用户分配角色（运营/销售/管理）和配置数据权限范围,  
So that 实现精细的权限管理。

---

## Acceptance Criteria

### AC 1: 进入权限配置页面
- **Given** 系统管理员进入用户管理页面  
- **When** 选择需要配置权限的用户并点击"权限配置"  
- **Then** 系统显示角色选择和数据权限配置界面  
- **And** 显示当前用户的角色和权限

### AC 2: 分配用户角色
- **Given** 系统管理员配置用户权限  
- **When** 选择用户角色（运营/销售/管理）  
- **Then** 系统保存用户角色  
- **And** 根据角色授予相应权限

### AC 3: 配置数据权限范围
- **Given** 系统管理员配置数据权限  
- **When** 配置数据访问范围  
- **Then** 系统支持按区域（华东/华南/华北）配置  
- **And** 支持按客户类型（A/B/C 类）配置

### AC 4: 权限验证
- **Given** 用户登录系统  
- **When** 访问数据或功能  
- **Then** 系统验证用户权限  
- **And** 无权限时拒绝访问并提示

---

## Tasks / Subtasks

- [ ] Task 1: 实现角色与权限 API (AC: 1, 2)
  - [ ] Subtask 1.1: GET /api/v1/roles - 获取角色列表
  - [ ] Subtask 1.2: PUT /api/v1/users/:id/role - 分配用户角色
  - [ ] Subtask 1.3: GET /api/v1/permissions - 获取权限列表

- [ ] Task 2: 实现数据权限 API (AC: 3, 4)
  - [ ] Subtask 2.1: PUT /api/v1/users/:id/data-permissions - 配置数据权限
  - [ ] Subtask 2.2: GET /api/v1/users/:id/data-permissions - 获取数据权限
  - [ ] Subtask 2.3: 实现权限验证中间件

- [ ] Task 3: 实现前端权限配置界面 (AC: 1, 2, 3)
  - [ ] Subtask 3.1: PermissionConfig.vue - 权限配置组件
  - [ ] Subtask 3.2: RoleSelector.vue - 角色选择器
  - [ ] Subtask 3.3: 路由配置

- [ ] Task 4: 编写单元测试 (AC: 2, 4)
  - [ ] Subtask 4.1: 测试角色分配 API
  - [ ] Subtask 4.2: 测试数据权限 API
  - [ ] Subtask 4.3: 测试权限验证逻辑

---

## Technical Implementation Notes

### Backend Implementation

**Roles and Permissions API:**
```python
GET /api/v1/roles
PUT /api/v1/users/:id/role
GET /api/v1/permissions
PUT /api/v1/users/:id/data-permissions
GET /api/v1/users/:id/data-permissions
```

**Permission Model:**
```python
class UserPermission(Base):
    user_id: int
    role: str  # admin, supervisor, operator, viewer
    data_regions: JSON  # ['east_china', 'south_china']
    data_customer_types: JSON  # ['A', 'B', 'C']
    permissions: JSON  # ['view_customer', 'edit_customer', ...]
```

**Permission Middleware:**
```python
def check_permission(permission: str):
    # Check if user has required permission
    # Check data scope (regions, customer types)
    pass
```

### Frontend Components

**New Components:**
- `PermissionConfig.vue` - Permission configuration dialog
- `RoleSelector.vue` - Role selection component
- Data scope selector (regions, customer types)

---

## Dependencies

- ✅ Story 5.1: 用户账户管理 (已完成 - User 模型)
- ✅ Story 3.2: JWT 认证 (已完成 - 认证基础)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Roles and permissions API working
- [ ] Data scope configuration implemented
- [ ] Permission validation middleware
- [ ] Frontend has permission configuration UI
- [ ] Unit tests pass (>90% coverage)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
