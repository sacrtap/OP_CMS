# Story 6.1: 数据质量验证与重复检测

**Status:** ready-for-dev  
**Epic:** Epic 6 - 数据导入导出  
**Story Points:** 5  
**Priority:** High  

---

## User Story

As a 系统,  
I want 可以对导入的数据进行质量验证（字段完整性、格式检查）和检测重复数据,  
So that 确保数据质量。

---

## Acceptance Criteria

### AC 1: 数据质量验证
- **Given** 运营人员上传 Excel 文件进行导入  
- **When** 系统解析数据时  
- **Then** 对数据进行质量验证（必填字段、格式检查）  
- **And** 标记不符合要求的数据

### AC 2: 必填字段验证
- **Given** 系统验证数据质量  
- **When** 检查必填字段（公司名称、联系人、联系电话）  
- **Then** 标记缺少必填字段的数据行  
- **And** 显示详细的错误信息

### AC 3: 格式检查
- **Given** 系统验证数据格式  
- **When** 检查字段格式（手机号、邮箱、信用代码）  
- **Then** 标记格式错误的数据  
- **And** 显示具体的格式错误原因

### AC 4: 重复数据检测
- **Given** 系统检测重复数据  
- **When** 检查唯一标识（公司名称、ERP 系统、信用代码）  
- **Then** 标记重复的数据行  
- **And** 显示与现有数据的匹配信息

---

## Tasks / Subtasks

- [ ] Task 1: 实现数据质量验证服务 (AC: 1, 2, 3)
  - [ ] Subtask 1.1: 创建 DataValidationService 服务类
  - [ ] Subtask 1.2: 实现必填字段验证
  - [ ] Subtask 1.3: 实现格式验证（手机号、邮箱、信用代码）

- [ ] Task 2: 实现重复数据检测 (AC: 4)
  - [ ] Subtask 2.1: 实现重复检测算法
  - [ ] Subtask 2.2: 支持多字段匹配（公司名称、信用代码、ERP 代码）
  - [ ] Subtask 2.3: 实现模糊匹配（相似度检测）

- [ ] Task 3: 实现验证 API (AC: 1, 4)
  - [ ] Subtask 3.1: POST /api/v1/import/validate - 验证导入数据
  - [ ] Subtask 3.2: POST /api/v1/import/check-duplicates - 检测重复数据
  - [ ] Subtask 3.3: 返回详细的验证报告

- [ ] Task 4: 编写单元测试 (AC: 2, 3, 4)
  - [ ] Subtask 4.1: 测试必填字段验证
  - [ ] Subtask 4.2: 测试格式验证
  - [ ] Subtask 4.3: 测试重复检测算法

---

## Technical Implementation Notes

### Backend Implementation

**Data Validation Service:**
```python
class DataValidationService:
    def validate_row(self, row_data: dict) -> ValidationResult:
        # Check required fields
        # Validate formats (phone, email, credit_code)
        # Return validation errors
        
    def check_duplicates(self, company_name: str, credit_code: str, erp_code: str) -> List[Customer]:
        # Check existing customers
        # Return matching customers
```

**Validation API:**
```python
POST /api/v1/import/validate
Request: {
  "data": [...],  // Array of rows
  "validate_format": true
}

Response: {
  "success": true,
  "data": {
    "total_rows": 100,
    "valid_rows": 95,
    "invalid_rows": 5,
    "validation_errors": [...]
  }
}
```

### Duplicate Detection

**Exact Match:**
- Company name (exact)
- Credit code (exact)
- ERP code (exact)

**Fuzzy Match:**
- Company name similarity (Levenshtein distance)
- Phone number similarity

---

## Dependencies

- ✅ Story 3.1: 自动化账单生成 (已完成 - Customer 模型)
- ✅ Story 1.4: 客户数据 excel 批量导入 (已完成 - 导入基础)

---

## Definition of Done

- [ ] All 4 ACs implemented and tested
- [ ] Data validation service working
- [ ] Duplicate detection algorithm implemented
- [ ] Validation API endpoints working
- [ ] Detailed validation reports
- [ ] Unit tests pass (>90% coverage)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

### Next Steps

---

## Change Log

- {{date}}: Story created from epics.md
