# OP_CMS Docker Compose - Production Configuration
# This file defines all services for the OP_CMS application

version: '3.8'

services:
  # Frontend Service - Vue 3 Application
  frontend:
    build:
      context: ../
      dockerfile: docker/frontend/Dockerfile
      target: production
    container_name: op_cms_frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      - NODE_ENV=production
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - op_cms_network
    volumes:
      - ./logs/nginx:/var/log/nginx
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Backend Service - Python Sanic API
  backend:
    build:
      context: ../
      dockerfile: docker/backend/Dockerfile
      target: production
    container_name: op_cms_backend
    restart: unless-stopped
    expose:
      - "8000"
    environment:
      - PYTHONUNBUFFERED=1
      - ENV=production
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER:-op_cms_user}:${MYSQL_PASSWORD:-op_cms_password}@mysql:3306/${MYSQL_DATABASE:-op_cms}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-change-this-in-production}
      - DEBUG=False
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - op_cms_network
    volumes:
      - ./logs/backend:/app/logs
      - ./backend/config:/app/backend/config
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # MySQL Database Service
  mysql:
    build:
      context: ./mysql
      dockerfile: Dockerfile
    container_name: op_cms_mysql
    restart: unless-stopped
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-op_cms}
      - MYSQL_USER=${MYSQL_USER:-op_cms_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-op_cms_password}
      - TZ=UTC
    volumes:
      - mysql_data:/var/lib/mysql
      - ./logs/mysql:/var/log/mysql
      - ./mysql/init-scripts:/docker-entrypoint-initdb.d
    networks:
      - op_cms_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Redis Cache Service
  redis:
    build:
      context: ./redis
      dockerfile: Dockerfile
    container_name: op_cms_redis
    restart: unless-stopped
    expose:
      - "6379"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redispassword}
    volumes:
      - redis_data:/data
    networks:
      - op_cms_network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redispassword}", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Celery Worker Service (Optional - for async tasks)
  celery-worker:
    build:
      context: ../
      dockerfile: docker/backend/Dockerfile
      target: production
    container_name: op_cms_celery_worker
    restart: unless-stopped
    command: celery -A backend.celery_app worker --loglevel=info
    environment:
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER:-op_cms_user}:${MYSQL_PASSWORD:-op_cms_password}@mysql:3306/${MYSQL_DATABASE:-op_cms}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - op_cms_network
    volumes:
      - ./logs/celery:/app/logs
    profiles:
      - with-celery

  # Celery Beat Service (Optional - for scheduled tasks)
  celery-beat:
    build:
      context: ../
      dockerfile: docker/backend/Dockerfile
      target: production
    container_name: op_cms_celery_beat
    restart: unless-stopped
    command: celery -A backend.celery_app beat --loglevel=info
    environment:
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER:-op_cms_user}:${MYSQL_PASSWORD:-op_cms_password}@mysql:3306/${MYSQL_DATABASE:-op_cms}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - op_cms_network
    volumes:
      - ./logs/celery:/app/logs
    profiles:
      - with-celery

networks:
  op_cms_network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
